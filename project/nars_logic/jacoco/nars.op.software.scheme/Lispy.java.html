<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Lispy.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS Logic Reasoner</a> &gt; <a href="index.source.html" class="el_package">nars.op.software.scheme</a> &gt; <span class="el_source">Lispy.java</span></div><h1>Lispy.java</h1><pre class="source lang-java linenums">package nars.op.software.scheme;

import org.jetbrains.annotations.NotNull;

import java.io.Console;
import java.lang.invoke.MethodHandle;
import java.lang.invoke.MethodHandles;
import java.math.BigInteger;
import java.util.*;

import static java.util.Arrays.asList;
import static java.util.Arrays.stream;
import static java.util.stream.Collectors.*;
import static java.util.stream.IntStream.range;
import static java.util.stream.Stream.concat;
import static java.util.stream.Stream.of;

/**
 * Lispy: Small Scheme Interpreter in Java 8
 * from: https://forax.github.io/2014-06-01-e733e6af6114eff55149-lispy_in_java.html
 */
<span class="nc" id="L22">public enum Lispy {</span>
    ;

    public interface Fun {
        @NotNull
        Object apply(Object a);
    }

    public interface Fun2 {
        @NotNull
        Object apply(Object a, Object b);
    }

    public interface FunAll {
        @NotNull
        Object apply(Object[] args);
    }

    static MethodHandle mhRef(@NotNull Class&lt;?&gt; type, String name) {
        try {
<span class="nc" id="L42">            return MethodHandles.publicLookup().unreflect(stream(type.getMethods()).filter(m -&gt; m.getName().equals(name)).findFirst().get());</span>
<span class="nc" id="L43">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L44">            throw new Error(e);</span>
        }
    }

    static &lt;F&gt; MethodHandle mh(@NotNull Class&lt;F&gt; type, F fun) {
<span class="nc" id="L49">        return mhRef(type, &quot;apply&quot;).bindTo(fun);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    static int compare(@NotNull Object a, @NotNull Object b) {
<span class="nc" id="L54">        return ((Comparable&lt;Object&gt;) a).compareTo(b);  // I hope Java will never have reified type</span>
    }

    @NotNull
    static List&lt;?&gt; list(@NotNull Object o) {
<span class="nc" id="L59">        return (List&lt;?&gt;) o;</span>
    }

    @NotNull
    static String string(@NotNull Object o) {
<span class="nc" id="L64">        return (String) o;</span>
    }

    static double dbl(@NotNull Object o) {
<span class="nc" id="L68">        return ((Number) o).doubleValue();</span>
    }

    @NotNull
    static BigInteger bigint(@NotNull Object o) {
<span class="nc" id="L73">        return ((BigInteger) o);</span>
    }

    static boolean isdbl(Object o) {
<span class="nc" id="L77">        return o instanceof Double;</span>
    }

    static class Env {
<span class="nc" id="L81">        final HashMap&lt;String, Object&gt; dict = new HashMap&lt;&gt;();</span>
        private final Env outer;

<span class="nc" id="L84">        Env(Env outer) {</span>
<span class="nc" id="L85">            this.outer = outer;</span>
<span class="nc" id="L86">        }</span>

        @NotNull
        Env find(String var) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            return dict.containsKey(var) ? this : outer.find(var);</span>
        }

        @NotNull
        Env add(String var, Object value) {
<span class="nc" id="L95">            dict.put(var, value);</span>
<span class="nc" id="L96">            return this;</span>
        }

        @NotNull
        Env addAll(@NotNull List&lt;?&gt; vars, @NotNull List&lt;?&gt; values) {
<span class="nc" id="L101">            range(0, vars.size()).forEach(i -&gt; add(string(vars.get(i)), values.get(i)));</span>
<span class="nc" id="L102">            return this;</span>
        }
    }

    @NotNull
    static Env globalEnv() {
<span class="nc" id="L108">        return new Env(null)</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">                .add(&quot;+&quot;, mh(Fun2.class, (a, b) -&gt; (isdbl(a) || isdbl(b)) ? dbl(a) + dbl(b) : bigint(a).add(bigint(b))))</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">                .add(&quot;-&quot;, mh(Fun2.class, (a, b) -&gt; (isdbl(a) || isdbl(b)) ? dbl(a) - dbl(b) : bigint(a).subtract(bigint(b))))</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">                .add(&quot;*&quot;, mh(Fun2.class, (a, b) -&gt; (isdbl(a) || isdbl(b)) ? dbl(a) * dbl(b) : bigint(a).multiply(bigint(b))))</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">                .add(&quot;/&quot;, mh(Fun2.class, (a, b) -&gt; (isdbl(a) || isdbl(b)) ? dbl(a) / dbl(b) : bigint(a).divide(bigint(b))))</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                .add(&quot;&lt;&quot;, mh(Fun2.class, (a, b) -&gt; compare(a, b) &lt; 0))</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                .add(&quot;&lt;=&quot;, mh(Fun2.class, (a, b) -&gt; compare(a, b) &lt;= 0))</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                .add(&quot;&gt;&quot;, mh(Fun2.class, (a, b) -&gt; compare(a, b) &gt; 0))</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                .add(&quot;&gt;=&quot;, mh(Fun2.class, (a, b) -&gt; compare(a, b) &gt;= 0))</span>
<span class="nc" id="L117">                .add(&quot;=&quot;, mhRef(Object.class, &quot;equals&quot;))</span>
<span class="nc" id="L118">                .add(&quot;equal?&quot;, mhRef(Object.class, &quot;equals&quot;))</span>
<span class="nc" id="L119">                .add(&quot;eq?&quot;, mh(Fun2.class, (o, c) -&gt; (((Class&lt;?&gt;) c).isInstance(o))))</span>
<span class="nc" id="L120">                .add(&quot;length&quot;, mhRef(List.class, &quot;size&quot;))</span>
<span class="nc" id="L121">                .add(&quot;cons&quot;, mh(Fun2.class, (a, l) -&gt; concat(of(a), list(l).stream()).collect(toList())))</span>
<span class="nc" id="L122">                .add(&quot;car&quot;, mh(Fun.class, l -&gt; list(l).get(0)))</span>
<span class="nc" id="L123">                .add(&quot;cdr&quot;, mh(Fun.class, l -&gt; list(l).subList(1, list(l).size())))</span>
<span class="nc" id="L124">                .add(&quot;append&quot;, mh(Fun2.class, (l, m) -&gt; concat(list(l).stream(), list(m).stream()).collect(toList())))</span>
<span class="nc" id="L125">                .add(&quot;list&quot;, mh(FunAll.class, Arrays::asList).asVarargsCollector(Object[].class))</span>
<span class="nc" id="L126">                .add(&quot;list?&quot;, mh(Fun.class, l -&gt; l instanceof List))</span>
<span class="nc" id="L127">                .add(&quot;null?&quot;, mhRef(List.class, &quot;isEmpty&quot;))</span>
<span class="nc" id="L128">                .add(&quot;symbol?&quot;, mh(Fun.class, a -&gt; a instanceof String));</span>
    }

    static Object eval(Object x, @NotNull Env env) {
        while (true) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (x instanceof String) {             // variable reference</span>
<span class="nc" id="L134">                return env.find(string(x)).dict.get(x);</span>
            }
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (!(x instanceof List)) {            // constant</span>
<span class="nc" id="L137">                return x;</span>
            }
<span class="nc" id="L139">            List&lt;?&gt; l = (List&lt;?&gt;) x;</span>
<span class="nc" id="L140">            Object cmd = l.get(0);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (cmd instanceof String) {</span>
                Object exp;
                String var;
<span class="nc bnc" id="L144" title="All 26 branches missed.">                switch (string(l.get(0))) {</span>
                    case &quot;quote&quot;:                        // (quote exp)
<span class="nc" id="L146">                        return l.get(1);</span>
                    case &quot;if&quot;:                           // (if test conseq alt)
<span class="nc bnc" id="L148" title="All 2 branches missed.">                        x = ((Boolean) eval(l.get(1), env)) ? l.get(2) : l.get(3);</span>
<span class="nc" id="L149">                        continue;</span>
                    case &quot;set!&quot;:                         // (set! var exp)
<span class="nc" id="L151">                        var = string(l.get(1));</span>
<span class="nc" id="L152">                        env.find(var).add(var, eval(l.get(2), env));</span>
<span class="nc" id="L153">                        return null;</span>
                    case &quot;define&quot;:                       // (define var exp)
<span class="nc" id="L155">                        var = string(l.get(1));</span>
<span class="nc" id="L156">                        env.add(var, eval(l.get(2), env));</span>
<span class="nc" id="L157">                        return null;</span>
                    case &quot;lambda&quot;:                       // (lambda (vars) exp)
<span class="nc" id="L159">                        List&lt;?&gt; vars = list(l.get(1));</span>
<span class="nc" id="L160">                        exp = l.get(2);</span>
<span class="nc" id="L161">                        return mh(FunAll.class, args -&gt; eval(exp, new Env(env).addAll(vars, asList(args)))).asCollector(Object[].class, vars.size());</span>
                    case &quot;begin&quot;:                        // (begin exp*)
<span class="nc" id="L163">                        return l.stream().skip(1).reduce(null, (val, e) -&gt; eval(e, env), (__1, __2) -&gt; null);</span>
                    default:
                }
            }
<span class="nc" id="L167">            List&lt;?&gt; exprs = l.stream().map(expr -&gt; eval(expr, env)).collect(toList());</span>
<span class="nc" id="L168">            MethodHandle proc = (MethodHandle) exprs.get(0);</span>
            try {
<span class="nc" id="L170">                return proc.invokeWithArguments(exprs.subList(1, exprs.size()));</span>
<span class="nc" id="L171">            } catch (Throwable e) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                if (e instanceof Error) throw (Error) e;</span>
<span class="nc" id="L173">                throw new Error(e);</span>
            }
        }
    }

    static Object parse(@NotNull String s) {
<span class="nc" id="L179">        return readFrom(tokenize(s));</span>
    }

    static Queue&lt;String&gt; tokenize(@NotNull String text) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">        return stream(text.replace(&quot;(&quot;, &quot;( &quot;).replace(&quot;)&quot;, &quot; )&quot;).split(&quot; &quot;)).filter(s -&gt; !s.isEmpty()).collect(toCollection(ArrayDeque::new));</span>
    }

    static Object readFrom(@NotNull Queue&lt;String&gt; tokens) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (tokens.isEmpty()) throw new Error(&quot;unexpected EOF while reading&quot;);</span>
<span class="nc" id="L188">        String token = tokens.poll();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (&quot;(&quot;.equals(token)) {</span>
<span class="nc" id="L190">            ArrayList&lt;Object&gt; l = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            while (!tokens.peek().equals(&quot;)&quot;)) {</span>
<span class="nc" id="L192">                l.add(readFrom(tokens));</span>
            }
<span class="nc" id="L194">            tokens.poll();   // pop of &quot;)&quot;</span>
<span class="nc" id="L195">            return l;</span>
        }
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (&quot;)&quot;.equals(token)) {</span>
<span class="nc" id="L198">            return new Error(&quot;unexpected ')'&quot;);</span>
        }
<span class="nc" id="L200">        return atom(token);</span>
    }

    static Object atom(@NotNull String token) {
        try {
<span class="nc" id="L205">            return new BigInteger(token);</span>
<span class="nc" id="L206">        } catch (NumberFormatException __) {</span>
            try {
<span class="nc" id="L208">                return Double.parseDouble(token);</span>
<span class="nc" id="L209">            } catch (NumberFormatException ___) {</span>
<span class="nc" id="L210">                return token;</span>
            }
        }
    }

    static String toString(Object val) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        return (val instanceof List) ? list(val).stream().map(Lispy::toString).collect(joining(&quot; &quot;, &quot;(&quot;, &quot;)&quot;)) : String.valueOf(val);</span>
    }

    static void repl() {
<span class="nc" id="L220">        Console console = System.console();</span>
<span class="nc" id="L221">        Env env = globalEnv();</span>
        for (; ; ) {
<span class="nc" id="L223">            Object val = eval(parse(console.readLine(&quot;lispy&gt; &quot;)), env);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (val != null) {</span>
<span class="nc" id="L225">                System.out.println(toString(val));</span>
            }
<span class="nc" id="L227">        }</span>
    }

    public static void main(String[] args) {
<span class="nc" id="L231">        repl();</span>
<span class="nc" id="L232">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>