<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TermFunction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS Logic Reasoner</a> &gt; <a href="index.source.html" class="el_package">nars.nal.nal8.operator</a> &gt; <span class="el_source">TermFunction.java</span></div><h1>TermFunction.java</h1><pre class="source lang-java linenums">package nars.nal.nal8.operator;

import com.google.common.collect.Lists;
import nars.NAR;
import nars.Symbols;
import nars.nal.Tense;
import nars.nal.nal8.Execution;
import nars.nal.nal8.Operator;
import nars.task.MutableTask;
import nars.task.Task;
import nars.term.Term;
import nars.term.TermBuilder;
import nars.term.atom.Atom;
import nars.term.compound.Compound;
import nars.truth.DefaultTruth;
import nars.truth.Truth;
import nars.util.Texts;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import java.util.List;


/** 
 * Superclass of functions that execute synchronously (blocking, in thread) and take
 * N input Global and one variable argument (as the final argument), generating a new task
 * with the result of the function substituted in the variable's place.
 */
public abstract class TermFunction&lt;O&gt; extends SyncOperator {

<span class="pc" id="L31">    private final float feedbackPriorityMultiplier = 1.0f;</span>
<span class="pc" id="L32">    private final float feedbackDurabilityMultiplier = 1.0f;</span>

<span class="fc" id="L34">    protected TermFunction() {</span>
<span class="fc" id="L35">    }</span>

    protected TermFunction(Term name) {
<span class="fc" id="L38">        super(name);</span>
<span class="fc" id="L39">    }</span>

    protected TermFunction(String name) {
<span class="nc" id="L42">        super(name);</span>
<span class="nc" id="L43">    }</span>

    public static int integer(@NotNull Term x, int defaultValue)  {
        try {
<span class="nc" id="L47">            return integer(x);</span>
        }
<span class="nc" id="L49">        catch (NumberFormatException e) {</span>
<span class="nc" id="L50">            return defaultValue;</span>
        }
    }

    public static int integer(@NotNull Term x) throws NumberFormatException {
<span class="nc" id="L55">        return Texts.i(Atom.unquote(x));</span>
    }

    public static boolean isPunctuation(char c) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        switch (c) {</span>
            case Symbols.JUDGMENT:
            case Symbols.GOAL:
            case Symbols.QUEST:
            case Symbols.QUESTION:
<span class="nc" id="L64">                return true;</span>
        }
<span class="nc" id="L66">        return false;</span>
    }

    /** y = function(x) 
     * @return y, or null if unsuccessful
     * @param x
     * @param i
     */
    @Nullable
    public abstract O function(Compound x, TermBuilder i);


    @Nullable
    protected List&lt;Task&gt; result(@NotNull NAR nar, @NotNull Task opTask, Term y/*, Term[] x0, Term lastTerm*/) {

<span class="fc" id="L81">        Compound operation = opTask.term();</span>

        //Variable var=new Variable(&quot;$1&quot;);
        //  Term actual_part = Similarity.make(var, y);
        //  Variable vardep=new Variable(&quot;#1&quot;);
        //Term actual_dep_part = Similarity.make(vardep, y);
//        operation=(Operation) operation.setComponent(0,
//                ((Compound)operation.getSubject()).setComponent(
//                        numArgs, y));

        //Examples:
        //      &lt;3 --&gt; (/,^add,1,2,_,SELF)&gt;.
        //      &lt;2 --&gt; (/,^count,{a,b},_,SELF)&gt;. :|: %1.00;0.99%
        //transform to image for perception variable introduction rule (is more efficient representation


        //final int numArgs = x0.length;

<span class="fc" id="L99">        Term inh = Operator.result(operation, y);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        if ((!(inh instanceof Compound))) {</span>
            //TODO wrap a non-Compound result as some kind of statement
<span class="nc" id="L102">            return null;</span>
        }

        //Implication.make(operation, actual_part, TemporalRules.ORDER_FORWARD);

<span class="fc" id="L107">        return Lists.newArrayList(</span>
<span class="fc" id="L108">                Operator.feedback(</span>
                    new MutableTask(inh).
<span class="fc" id="L110">                        judgment().</span>
<span class="fc" id="L111">                        truth(getResultFrequency(), getResultConfidence()).</span>
<span class="fc" id="L112">                        tense(getResultTense(), nar.memory), opTask,</span>
                        feedbackPriorityMultiplier, feedbackDurabilityMultiplier)
            );

            /*float equal = equals(lastTerm, y);
            ArrayList&lt;Task&gt; rt = Lists.newArrayList(
                    m.newTask(actual, Symbols.JUDGMENT_MARK,
                            1.0f, confidence,
                            Global.DEFAULT_JUDGMENT_PRIORITY,
                            Global.DEFAULT_JUDGMENT_DURABILITY,
                            operation.getTask()));

            if (equal &lt; 1.0f) {
                rt.add(m.newTask(operation, Symbols.JUDGMENT_MARK,
                            equal, confidence,
                            Global.DEFAULT_JUDGMENT_PRIORITY,
                            Global.DEFAULT_JUDGMENT_DURABILITY,
                            operation.getTask()));
            }
            return rt;
            */




    }

    /** default tense applied to result tasks */
    @NotNull
    public Tense getResultTense() {
<span class="fc" id="L142">        return Tense.Present;</span>
    }

    /** default confidence applied to result tasks */
    public float getResultFrequency() {
<span class="fc" id="L147">        return 1.0f;</span>
    }


    /** default confidence applied to result tasks */
    public float getResultConfidence() {
<span class="fc" id="L153">        return 0.99f;</span>
    }



//    protected ArrayList&lt;Task&gt; result2(Operation operation, Term y, Term[] x0, Term lastTerm) {
//        //since Peis approach needs it to directly generate op(...,$output) =|&gt; &lt;$output &lt;-&gt; result&gt;,
//        //which wont happen on temporal induction with dependent variable for good rule,
//        //because in general the two dependent variables of event1 and event2
//        //can not be assumed to be related, but here we have to assume
//        //it if we don't want to use the &quot;resultof&quot;-relation.
//
//
//        Compound actual = Implication.make(
//                operation.cloneWithArguments(x0, var),
//                Similarity.make(var, y),
//                TemporalRules.ORDER_FORWARD);
//
//        if (actual == null) return null;
//
//        Compound actual_dep_part = lastTerm!=null ? Similarity.make(lastTerm, y) : null;
//
//
//        float confidence = operation.getTask().getConfidence();
//        //TODO add a delay discount/projection for executions that happen further away from creation time
//
//        return Lists.newArrayList(
//
//                TaskSeed.make(nar.memory, actual).judgment()
//                        .budget(Global.DEFAULT_JUDGMENT_PRIORITY, Global.DEFAULT_JUDGMENT_DURABILITY)
//                        .truth(getResultFrequency(), getResultConfidence())
//                        .parent(operation.getTask())
//                        .tense(getResultTense()),
//
//                actual_dep_part != null ?
//                        TaskSeed.make(nar.memory, actual_dep_part).judgment()
//                                .budget(Global.DEFAULT_JUDGMENT_PRIORITY, Global.DEFAULT_JUDGMENT_DURABILITY)
//                                .truth(1f, confidence)
//                                .present()
//                                .parent(operation.getTask()) : null
//
//        );
//
//    }

//    @Override
//    protected void noticeExecuted(Task&lt;Operation&gt; operation) {
//        //no notice
//    }




    @Override
    public void execute(@NotNull Execution e) {

<span class="fc" id="L209">        Task opTask = e.task;</span>
<span class="fc" id="L210">        Compound operation = opTask.term();</span>

        //Term opTerm = Compounds.operatorTerm(operation);
        //Term[] x = Compounds.args(operation).terms();

        //Memory memory = nar.memory;

//        int numInputs = x.length;
//        if (x[numInputs - 1].equals(memory.self()))
//            numInputs--;
//
//        Term lastTerm = null;
//        if (x[numInputs - 1] instanceof Variable) {
//            lastTerm = x[numInputs-1];
//            numInputs--;
//        }

        //Term[] x0 = operation.getArgumentTerms(false, memory);


<span class="fc" id="L230">        Object y = function(Operator.opArgs(operation), e.nar.index());</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (y == null) {</span>
<span class="fc" id="L232">            return;</span>
        }

<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        if (y instanceof Boolean) {</span>
<span class="nc" id="L236">            boolean by = (Boolean)y;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            y = new DefaultTruth(by ? 1 : 0, 0.99f);</span>
        }
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">        if (y instanceof Truth) {</span>
            //this will get the original input operation term, not after it has been inlined.

<span class="nc" id="L242">            e.nar.input(</span>
<span class="nc" id="L243">                new MutableTask(operation).judgment()</span>
<span class="nc" id="L244">                        .truth((Truth) y).eternal()</span>
            );

<span class="nc" id="L247">            return;</span>
        }


<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        if (y instanceof Number) {</span>
<span class="nc" id="L252">            y = (Atom.the((Number)y));</span>
        }

<span class="pc bpc" id="L255" title="1 of 2 branches missed.">        if (y instanceof Task) {</span>
<span class="nc" id="L256">            e.feedback( Lists.newArrayList((Task)y) );</span>
<span class="nc" id="L257">            return;</span>
        }
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">        if (y instanceof Term) {</span>
<span class="fc" id="L260">            e.feedback( result(e.nar, opTask, (Term) y/*, x, lastTerm*/) );</span>
<span class="fc" id="L261">            return;</span>
        }


<span class="nc" id="L265">        String ys = y.toString();</span>


        //1. try to parse as task
<span class="nc" id="L269">        char mustBePuncToBeTask = ys.charAt(ys.length()-1); //early prevention from invoking parser</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">        if (isPunctuation(mustBePuncToBeTask) || mustBePuncToBeTask == ':' /* tense ending character */) {</span>
            try {
<span class="nc" id="L272">                Task t = e.nar.task(ys);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (t != null) {</span>
<span class="nc" id="L274">                    e.feedback( t );</span>
<span class="nc" id="L275">                    return;</span>
                }
<span class="nc" id="L277">            } catch (Throwable t) {</span>
<span class="nc" id="L278">                t.printStackTrace();</span>
<span class="nc" id="L279">            }</span>
        }

        //2. try to parse as term

<span class="nc" id="L284">        Term t = Atom.the(ys, true);</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (t != null) {</span>
<span class="nc" id="L287">            e.feedback( result(e.nar, opTask, t/*, x, lastTerm*/) );</span>
<span class="nc" id="L288">            return;</span>
        }

<span class="nc" id="L291">        throw new RuntimeException(this + &quot; return value invalid: &quot; + y);</span>
    }

    /** the term that the output will inherit from; analogous to the 'Range' of a function in mathematical terminology */
    //protected Term getRange() {        return null;    }

    //protected int getMinArity() {        return 0;    }
    //abstract protected int getMaxArity();


    /** (can be overridden in subclasses) the extent to which it is truth 
     * that the 2 given terms are equal.  in other words, a distance metric
     */
    public float equals(@NotNull Term a, Term b) {
        //default: Term equality
<span class="nc bnc" id="L306" title="All 2 branches missed.">        return a.equals(b) ? 1.0f : 0.0f;</span>
    }
}



//if (variable) {
//}
//else {
            /*float equal = equals(lastTerm, y);



            float confidence = 0.99f;
            ArrayList&lt;Task&gt; rt = Lists.newArrayList(
                    m.newTaskAt(actual, Symbols.JUDGMENT,
                            1.0f, confidence,
                            Global.DEFAULT_JUDGMENT_PRIORITY,
                            Global.DEFAULT_JUDGMENT_DURABILITY,
                            operation.getTask()));

            if (equal &lt; 1.0f) {
                rt.add(m.newTaskAt(operation, Symbols.JUDGMENT,
                            equal, confidence,
                            Global.DEFAULT_JUDGMENT_PRIORITY,
                            Global.DEFAULT_JUDGMENT_DURABILITY,
                            operation.getTask()));
            }
            return rt;
            */

//   return null;

//}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>