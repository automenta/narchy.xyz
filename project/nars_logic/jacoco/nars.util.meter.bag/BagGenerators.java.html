<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BagGenerators.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS Logic Reasoner</a> &gt; <a href="index.source.html" class="el_package">nars.util.meter.bag</a> &gt; <span class="el_source">BagGenerators.java</span></div><h1>BagGenerators.java</h1><pre class="source lang-java linenums">package nars.util.meter.bag;

import nars.bag.BLink;
import nars.bag.Bag;
import nars.util.data.Util;
import nars.util.data.random.XORShiftRandom;
import org.jetbrains.annotations.NotNull;

import java.util.Random;


/**
 * Created by me on 9/2/15.
 */
<span class="nc" id="L15">public enum BagGenerators {</span>
    ;

<span class="nc" id="L18">    static final Random rng = new XORShiftRandom();</span>




//    public static int[] testRemovalPriorityDistribution(int loops, int insertsPerLoop, float fractionToAdjust, float fractionToRemove, Bag&lt;CharSequence, NullItem&gt; f) {
//        return testRemovalPriorityDistribution(loops, insertsPerLoop, fractionToAdjust, fractionToRemove, f, true);
//    }

    @NotNull
    public static int[] testRemovalPriorityDistribution(int loops, int insertsPerLoop, float fractionToRemove, @NotNull Bag&lt;CharSequence&gt; f) {

<span class="nc" id="L30">        int levels = 13;</span>
<span class="nc" id="L31">        int[] count = new int[levels];</span>

<span class="nc" id="L33">        int[] nRemoved = {0};</span>

//        Consumer&lt;NullItem&gt; prevRemoval = f.getOnRemoval();
//        f.setOnRemoval(r -&gt; {
//            nRemoved[0] = removal(nRemoved[0], r.getPriority(), count);
//            prevRemoval.accept(r);
//        });


<span class="nc bnc" id="L42" title="All 2 branches missed.">        for (int l = 0; l &lt; loops; l++) {</span>


            //fill with random items
<span class="nc bnc" id="L46" title="All 2 branches missed.">            for (int i= 0; i &lt; insertsPerLoop; i++) {</span>

<span class="nc" id="L48">                CharSequence k = Float.toString(rng.nextFloat());</span>

<span class="nc" id="L50">                BLink&lt;CharSequence&gt; overflow = f.put(k);</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">                if (overflow!=null) {</span>
<span class="nc" id="L52">                    float p = overflow.getPriority();</span>
<span class="nc" id="L53">                    nRemoved[0] = removal(nRemoved[0], p, count);</span>
                }

            }

            //System.out.println(f.size() + &quot;/&quot; + f.capacity() + &quot; : &quot; + f.getPriorityMin() + &quot;..&quot; + f.getPriorityMax());


            //assertEquals(items.size(), f.size());

            //Assert.assertEquals(preadjustCount, postadjustCount);

<span class="nc" id="L65">            float min = f.getPriorityMin();</span>
<span class="nc" id="L66">            float max = f.getPriorityMax();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (min &gt; max) {</span>
                //f.printAll();
<span class="nc" id="L69">                throw new RuntimeException(&quot;out of order&quot;);</span>
            }

            /*if (requireOrder) {

                //Assert.assertTrue(max &gt;= min);
            }*/


            //remove last than was inserted so the bag never gets empty
<span class="nc bnc" id="L79" title="All 2 branches missed.">            for (int i = 0; i &lt; insertsPerLoop * fractionToRemove; i++) {</span>
<span class="nc" id="L80">                int sizeBefore = f.size();</span>

<span class="nc" id="L82">                CharSequence t = f.sample().get();</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (t == null) {</span>
                    //Assert.assertTrue(sizeAfter == 0);
                    //Assert.assertEquals(sizeAfter, sizeBefore);
<span class="nc" id="L87">                    continue;</span>
                }
                //Assert.assertEquals(sizeAfter, sizeBefore-1);

<span class="nc" id="L91">                int sizeAfter = f.size();</span>

<span class="nc" id="L93">                float p = f.get(t).getPriority();</span>

                //String expected = (min + &quot; &gt; &quot;+ p + &quot; &gt; &quot; + max);
                /*if (requireOrder) {
                    //Assert.assertTrue(expected, p &gt;= min);
                    //Assert.assertTrue(expected, p &lt;= max);
                    throw new RuntimeException(&quot;out of order2&quot;);
                }*/

<span class="nc" id="L102">                nRemoved[0] = removal(nRemoved[0], p, count);</span>
            }

            //Assert.assertEquals(postadjustCount-nRemoved, f.size());

            //nametable and itemtable consistent size
            //assertEquals(items.size(), f.size());
            //System.out.printMeaning(&quot;  &quot;); items.reportPriority();

        }


        //System.out.println(items.getClass().getSimpleName() + &quot;,&quot; + random + &quot;,&quot; + capacity + &quot;: &quot; + Arrays.toString(count));

<span class="nc" id="L116">        return count;</span>


        //removal rates are approximately monotonically increasing function
        //assert(count[0] &lt;= count[N-2]);
        //assert(count[N/2] &lt;= count[N-2]);

        //System.out.println(random + &quot; &quot; + Arrays.toString(count));
        //System.out.println(count[0] + &quot; &quot; + count[1] + &quot; &quot; + count[2] + &quot; &quot; + count[3]);

    }

    protected static int removal(int nRemoved, float p, @NotNull int[] count) {

<span class="nc" id="L130">        int l = count.length;</span>
<span class="nc" id="L131">        int level = Util.bin(p, l);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (level &gt;= l) level= l - 1;</span>
<span class="nc" id="L133">        count[level]++;</span>
<span class="nc" id="L134">        nRemoved++;</span>
<span class="nc" id="L135">        return nRemoved;</span>
    }

    @NotNull
    public static int[] testRetaining(int loops, int insertsPerLoop, @NotNull Bag&lt;CharSequence&gt; f) {

<span class="nc" id="L141">        int levels = 9;</span>
<span class="nc" id="L142">        int[] count = new int[levels];</span>


<span class="nc bnc" id="L145" title="All 2 branches missed.">        for (int l = 0; l &lt; loops; l++) {</span>
            //fill with random items
<span class="nc bnc" id="L147" title="All 2 branches missed.">            for (int i= 0; i &lt; insertsPerLoop; i++) {</span>
<span class="nc" id="L148">                f.put(Float.toString(rng.nextFloat()));</span>
            }



            //nametable and itemtable consistent size
            //assertEquals(items.size(), f.size());
            //System.out.printMeaning(&quot;  &quot;); items.reportPriority();

        }


<span class="nc" id="L160">        return count;</span>
    }

/*
            int preadjustCount = f.size();
            //assertEquals(items.size(), f.size());

            //remove some, adjust their priority, and re-insert
            for (int i= 0; i &lt; insertsPerLoop * adjustFraction; i++) {
                f.size();

                NullItem t = f.pop();

                f.size();

                if (t == null) break;
                if (i % 2 == 0)
                    t.setPriority(t.getPriority() * 0.99f);
                else
                    t.setPriority(Math.min(1.0f, t.getPriority() * 1.01f));

                NullItem overflow = f.put(t);
                if (overflow!=null)
                    removal(nRemoved[0], overflow.getPriority(), count);
            }

            int postadjustCount = f.size();
 */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>