<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NARLoop.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS Logic Reasoner</a> &gt; <a href="index.source.html" class="el_package">nars</a> &gt; <span class="el_source">NARLoop.java</span></div><h1>NARLoop.java</h1><pre class="source lang-java linenums">package nars;

import nars.util.data.Util;
import net.openhft.affinity.AffinityLock;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;

import static org.slf4j.LoggerFactory.getLogger;

/**
 * self managed set of processes which run a NAR
 * as a loop at a certain frequency.
 */
public class NARLoop implements Runnable {

<span class="nc" id="L16">    static final Logger logger = getLogger(NARLoop.class);</span>

    @NotNull
    public final NAR nar;

    @NotNull
    private final Thread thread;

    /**
     * sleep mode delay time
     */
    static final long sleepTimeMS = 250;
    private final boolean cpuCoreReserve;


<span class="nc" id="L31">    public volatile int cyclesPerFrame = 1;</span>
<span class="nc" id="L32">    volatile int periodMS = 1000;</span>
<span class="nc" id="L33">    private volatile boolean stopped = false;</span>
    //private boolean running;

    //TODO make this into a SimpleIntegerProperty also


    @NotNull
    @Override
    public String toString() {
<span class="nc" id="L42">        return nar + &quot;:loop@&quot; + getFrequency() + &quot;Hz&quot;;</span>
    }

    //in Hz / fps
    public double getFrequency() {
<span class="nc" id="L47">        return 1000.0 / periodMS;</span>
    }

    public int getPeriodMS() {
<span class="nc" id="L51">        return periodMS;</span>
    }


    public NARLoop(@NotNull NAR n, int initialPeriod) {
<span class="nc" id="L56">        this(n, initialPeriod, false);</span>
<span class="nc" id="L57">    }</span>

    /**
     *
     * @param n
     * @param initialPeriod
     * @param reserveCPUCore whether to acquire a thread affinity lock on a CPU core, which will improve performance if a dedicated core can be assigned
     */
<span class="nc" id="L65">    public NARLoop(@NotNull NAR n, int initialPeriod, boolean reserveCPUCore) {</span>


<span class="nc" id="L68">        nar = n;</span>
<span class="nc" id="L69">        cpuCoreReserve = reserveCPUCore;</span>

<span class="nc" id="L71">        n.the(&quot;loop&quot;, this);</span>

<span class="nc" id="L73">        setPeriodMS(initialPeriod);</span>

<span class="nc" id="L75">        thread = new Thread(this, n.self + &quot;:loop&quot;);</span>
<span class="nc" id="L76">        thread.start();</span>
<span class="nc" id="L77">        logger.info(&quot;starting {}&quot;, thread);</span>
<span class="nc" id="L78">    }</span>


    public final boolean setPeriodMS(int period) {
<span class="nc" id="L82">        int prevPeriod = periodMS;</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (prevPeriod == period) return false;</span>

<span class="nc" id="L86">        periodMS = period;</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (period == -1) {</span>
<span class="nc" id="L88">            logger.info(&quot;pause&quot;);</span>
        } else {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (prevPeriod == -1)</span>
<span class="nc" id="L91">                logger.info(&quot;resume:period={}&quot;, period);</span>
            else {
                //dont log change in period, too noisy
            }
        }

        //thread priority control
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (thread != null) {</span>
<span class="nc" id="L99">            int pri = thread.getPriority();</span>
<span class="nc" id="L100">            int fullThrottlePri = Thread.MIN_PRIORITY;</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">            int targetPri = periodMS == 0 ? fullThrottlePri : Thread.NORM_PRIORITY;</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (targetPri != pri)</span>
<span class="nc" id="L105">                thread.setPriority(fullThrottlePri);</span>

<span class="nc" id="L107">            thread.interrupt();</span>

        }


<span class="nc" id="L112">        return true;</span>
    }

    public void stop() {
<span class="nc" id="L116">        logger.info(&quot;stopping {}&quot;, this);</span>
<span class="nc" id="L117">        stopped = true;</span>
<span class="nc" id="L118">    }</span>

    public void waitForTermination() throws InterruptedException {
<span class="nc" id="L121">        stop();</span>
<span class="nc" id="L122">        thread.join();</span>
<span class="nc" id="L123">    }</span>

    @Override
    public final void run() {




        AffinityLock al;
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (cpuCoreReserve) {</span>
<span class="nc" id="L133">            al = AffinityLock.acquireLock();</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">            if (al.isAllocated() &amp;&amp; al.isBound()) {</span>
<span class="nc" id="L135">                logger.info(thread + &quot; running exclusively on CPU &quot; +  al.cpuId());</span>
            }
        }
        else {
<span class="nc" id="L139">            al = null;</span>
        }

        try {
<span class="nc" id="L143">            NAR nar = this.nar;</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (periodMS != -1)</span>
<span class="nc" id="L146">                logger.info(&quot;started, period={}&quot;, periodMS);</span>

            do {
                try {
<span class="nc bnc" id="L150" title="All 2 branches missed.">                    while (!stopped)</span>
<span class="nc" id="L151">                        frame(nar);</span>
<span class="nc" id="L152">                } catch (Exception e) {</span>
<span class="nc" id="L153">                    nar.memory.eventError.emit(e);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                    if (Global.DEBUG) stopped = true;</span>
<span class="nc" id="L155">                }</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            } while (!stopped);</span>

        } finally {
<span class="nc bnc" id="L159" title="All 4 branches missed.">            if (al!=null)</span>
<span class="nc" id="L160">                al.release();</span>
        }

<span class="nc" id="L163">        logger.info(&quot;stopped&quot;);</span>
<span class="nc" id="L164">    }</span>

    public void frame(@NotNull NAR nar) {
<span class="nc" id="L167">        int periodMS = this.periodMS;</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (periodMS &lt; 0) {</span>
            //idle
<span class="nc" id="L171">            Util.pause(sleepTimeMS);</span>
        } else {

<span class="nc" id="L174">            long start = System.currentTimeMillis();</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (!nar.running.get()) {</span>
<span class="nc" id="L177">                nar.frame(cyclesPerFrame);</span>
<span class="nc" id="L178">                throttle(periodMS, System.currentTimeMillis() - start);</span>
            } else {
                //logger.warn(&quot;nar began running before this frame attempted to start&quot;);
<span class="nc" id="L181">                Thread.yield();</span>
            }
        }

<span class="nc" id="L185">    }</span>

    protected static long throttle(long minFramePeriodMS, long frameTimeMS) {
<span class="nc" id="L188">        double remainingTime = (minFramePeriodMS - frameTimeMS) / 1.0E3;</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (remainingTime &gt; 0) {</span>

            //        try {
//            Thread.sleep(sleepTime);
//        } catch (InterruptedException e) {
//            //e.printStackTrace();
//        }

<span class="nc" id="L198">            Util.pause(minFramePeriodMS);</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        } else if (remainingTime &lt; 0) {</span>

<span class="nc" id="L202">            Thread.yield();</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (Global.DEBUG) {</span>
                //TODO blink a non-intrusive indicator in GUI
<span class="nc" id="L206">                logger.warn(&quot;lag {}ms&quot;, remainingTime);</span>
            }

            //minFramePeriodMS++;
            //; incresing frame period to &quot; + minFramePeriodMS + &quot;ms&quot;);
        }
<span class="nc" id="L212">        return minFramePeriodMS;</span>
    }


    public final void pause() {
<span class="nc" id="L217">        setPeriodMS(-1);</span>
<span class="nc" id="L218">    }</span>

//    //TODO not well tested
//    public void setRunning(boolean r) {
//        this.running = r;
//    }
//
//    public boolean isRunning() {
//        return running;
//    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>