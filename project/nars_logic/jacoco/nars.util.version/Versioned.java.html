<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Versioned.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS Logic Reasoner</a> &gt; <a href="index.source.html" class="el_package">nars.util.version</a> &gt; <span class="el_source">Versioned.java</span></div><h1>Versioned.java</h1><pre class="source lang-java linenums">package nars.util.version;

import nars.util.data.list.FasterIntArrayList;
import nars.util.data.list.FasterList;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

/**
 * Maintains a versioned snapshot history (stack) of a changing value
 */
public class Versioned&lt;X&gt; extends FasterIntArrayList /*Comparable&lt;Versioned&gt;*/ {

    public final FasterList&lt;X&gt; value;
    @NotNull
    private final Versioning context;

    /**
     * id, unique within the context this has registered with
     */
    private final int id;

    public Versioned(@NotNull Versioning context) {
<span class="fc" id="L23">        this(context, context.newIntStack(), context.newValueStack());</span>
<span class="fc" id="L24">    }</span>

    public Versioned(@NotNull Versioning context, int[] buffer, FasterList&lt;X&gt; value) {
<span class="fc" id="L27">        super(buffer);</span>
<span class="fc" id="L28">        this.context = context;</span>
<span class="fc" id="L29">        this.value = value;</span>
<span class="fc" id="L30">        id = context.track();</span>
<span class="fc" id="L31">    }</span>

    /** called when this versioned is removed/deleted from a context */
    void delete() {
<span class="fc" id="L35">        context.onDeleted(this);</span>
<span class="fc" id="L36">    }</span>

    @Override
    public final boolean equals(Object otherVersioned) {
<span class="nc bnc" id="L40" title="All 2 branches missed.">        return this == otherVersioned;</span>
    }

    @Override
    public final int hashCode() {
<span class="nc" id="L45">        return id;</span>
    }


    boolean revertNext(int before) {
<span class="fc" id="L50">        int p = size - 1;</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">        if (p &gt;= 0) {</span>
<span class="fc" id="L52">            int[] a = items;</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">            if (a[p--] &gt; before) {</span>
<span class="fc" id="L54">                popTo(p);</span>
<span class="fc" id="L55">                value.popTo(p);</span>
<span class="fc" id="L56">                return true;</span>
            }
        }
<span class="fc" id="L59">        return false;</span>
    }


    public int lastUpdatedAt() {
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (isEmpty()) return -1;</span>
<span class="fc" id="L65">        return getLast();</span>
    }

    /*@Override
    public int compareTo(Versioned o) {
        return Integer.compare(o.now(), now());
    }*/

    /**
     * gets the latest value
     */
    public final X get() {
<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (size == 0) return null;</span>
<span class="fc" id="L78">        return value.getLast();</span>
    }

//    /**
//     * gets the latest value at a specific time, rolling back as necessary
//     */
//    public X revertThenGet(int now) {
//        revert(now);
//        return latest();
//    }

    /**
     * sets thens commits
     */
    public void set(X nextValue) {
<span class="fc" id="L93">        set(context.newChange(this), nextValue);</span>
<span class="fc" id="L94">    }</span>

    /**
     * set but does not commit;
     * a commit should precede this call otherwise it will have the version of a previous commit
     */
    @NotNull
    public Versioning thenSet(X nextValue) {
<span class="nc" id="L102">        Versioning ctx = context;</span>
<span class="nc" id="L103">        set(ctx.continueChange(this), nextValue);</span>
<span class="nc" id="L104">        return ctx;</span>
    }

    /**
     * sets at a specific time but does not commit;
     * make sure to call commit on the returned context after
     * all concurrent set() are finished
     */
    @NotNull
    final Versioning set(int now, X nextValue) {

<span class="fc" id="L115">        add(now);</span>
<span class="fc" id="L116">        value.add(nextValue);</span>

<span class="fc" id="L118">        return context;</span>
    }


    @Override
    public void clear() {
<span class="nc" id="L124">        super.clear();</span>
<span class="nc" id="L125">        value.clear();</span>
<span class="nc" id="L126">    }</span>

    @Override
    public final String toString() {
<span class="fc" id="L130">        X v = get();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (v != null)</span>
<span class="fc" id="L132">            return v.toString();</span>
<span class="fc" id="L133">        return &quot;null&quot;;</span>
    }

    public final String toStackString() {
<span class="fc" id="L137">        StringBuilder sb = new StringBuilder(&quot;(&quot;);</span>
<span class="fc" id="L138">        int s = size();</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">        for (int i = 0; i &lt; s; i++) {</span>
            //sb.append('(');
<span class="fc" id="L141">            sb.append(get(i));</span>
<span class="fc" id="L142">            sb.append(':');</span>
<span class="fc" id="L143">            sb.append(value.get(i));</span>
            //sb.append(')');
<span class="fc bfc" id="L145" title="All 2 branches covered.">            if (i &lt; s - 1)</span>
<span class="fc" id="L146">                sb.append(&quot;, &quot;);</span>
        }
<span class="fc" id="L148">        sb.append(')');</span>
<span class="fc" id="L149">        return sb.toString();</span>

    }

//    public int setInt(IntToIntFunction f) {
//        Integer x = (Integer) get();
//        Integer y = f.valueOf(x);
//        set(y);
//    }

    @Nullable
    public X getIfAbsent(X valueIfMissing) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (isEmpty()) return valueIfMissing;</span>
<span class="nc" id="L162">        X x = get();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (x == null) return valueIfMissing;</span>
<span class="nc" id="L164">        return x;</span>
    }

//    public long getIfAbsent(long valueIfMissing) {
//        if (isEmpty()) return valueIfMissing;
//        return ((Long) get());
//    }

    @Deprecated public int getIfAbsent(int valueIfMissing) {
<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (isEmpty()) return valueIfMissing;</span>
<span class="fc" id="L174">        Integer i  = (Integer) get();</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (i == null) return valueIfMissing;</span>
<span class="fc" id="L176">        return i;</span>
    }

//    public char getIfAbsent(char valueIfMissing) {
//        if (isEmpty()) return valueIfMissing;
//        return ((Character) get());
//    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>