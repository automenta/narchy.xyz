<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>js.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS Logic Reasoner</a> &gt; <a href="index.source.html" class="el_package">nars.op.software</a> &gt; <span class="el_source">js.java</span></div><h1>js.java</h1><pre class="source lang-java linenums">package nars.op.software;

import nars.NAR;
import nars.nal.nal8.Execution;
import nars.nal.nal8.Operator;
import nars.nal.nal8.operator.NullOperator;
import nars.nal.nal8.operator.TermFunction;
import nars.op.mental.Mental;
import nars.task.Task;
import nars.term.Term;
import nars.term.TermBuilder;
import nars.term.atom.Atom;
import nars.term.compound.Compound;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import javax.script.Bindings;
import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.script.SimpleBindings;
import java.util.HashMap;

/**
 * Executes a Javascript expression
 */
<span class="fc" id="L26">public class js extends TermFunction implements Mental {</span>

<span class="fc" id="L28">    private static final ThreadLocal&lt;ScriptEngine&gt; js = new ThreadLocal&lt;ScriptEngine&gt;() {</span>
        @Override
        protected ScriptEngine initialValue() {
<span class="nc" id="L31">            ScriptEngineManager factory = new ScriptEngineManager();</span>
<span class="nc" id="L32">            js.set(factory.getEngineByName(&quot;JavaScript&quot;));</span>
<span class="nc" id="L33">            return js.get();</span>
        }
    };

<span class="fc" id="L37">    final HashMap global = new HashMap();</span>

    class DynamicFunction extends TermFunction {

        private final String function;
        private Object fnCompiled;

<span class="nc" id="L44">        public DynamicFunction(String name, String function) {</span>
<span class="nc" id="L45">            super(name);</span>
<span class="nc" id="L46">            this.function = function;</span>

            try {
<span class="nc" id="L49">                fnCompiled = js.get().eval(function);</span>
            }
<span class="nc" id="L51">            catch (Throwable ex) {</span>
<span class="nc" id="L52">                ex.printStackTrace();</span>
<span class="nc" id="L53">            }</span>
<span class="nc" id="L54">        }</span>

        @Override public Object function(@NotNull Compound o, TermBuilder i) {
<span class="nc" id="L57">            Term[] args = Operator.opArgsArray(o);</span>
<span class="nc" id="L58">            Bindings bindings = newBindings(null, args);</span>
<span class="nc" id="L59">            bindings.put(&quot;_o&quot;, fnCompiled);</span>

            Object result;
            try {
<span class="nc" id="L63">                String input = &quot;_o.apply(this,arg)&quot;;</span>
<span class="nc" id="L64">                result = js.get().eval(input, bindings);</span>
<span class="nc" id="L65">            } catch (Throwable ex) {</span>
<span class="nc" id="L66">                ex.printStackTrace();</span>
<span class="nc" id="L67">                throw new RuntimeException(ex);</span>
<span class="nc" id="L68">            }</span>
<span class="nc" id="L69">            return result;</span>
        }


    }

    /** create dynamic javascript functions */
    //TODO make this an ImmediateOperator that will not conceptualize its subterms
<span class="nc" id="L77">    public class jsop extends NullOperator {</span>

        @Override
        public void execute(@NotNull Execution e) {
<span class="nc" id="L81">            Task op = e.task;</span>
<span class="nc" id="L82">            Term[] x = Operator.opArgsArray(op.term());</span>
<span class="nc" id="L83">            String funcName = Atom.unquote(x[0]);</span>
<span class="nc" id="L84">            String functionCode = Atom.unquote(x[1]);</span>
            //nar.input( echo.newTask(&quot;JS Operator Bind: &quot; + funcName + &quot; = &quot; + functionCode));
<span class="nc" id="L86">            DynamicFunction d = new DynamicFunction(funcName, functionCode);</span>
<span class="nc" id="L87">            e.nar.onExec(d);</span>

            //op.stop();
<span class="nc" id="L90">        }</span>



    }

//    public class JSBelievedConceptBuilder extends ConstantConceptBuilder {
//
//        private Object fnCompiled;
//
//        public JSBelievedConceptBuilder(String fnsource) {
//
//            ensureJSLoaded();
//
//            try {
//                this.fnCompiled = js.eval(fnsource);
//            }
//            catch (Throwable ex) {
//                ex.printStackTrace();
//            }
//        }
//
//
//        @Override
//        protected Truth truth(Term t, Memory m) {
//
//            Bindings bindings = new SimpleBindings();
//            bindings.put(&quot;t&quot;, t);
//            bindings.put(&quot;_o&quot;, fnCompiled);
//            String input = &quot;_o.apply(this,[t])&quot;;
//
//            Object result;
//            try {
//                result = js.eval(input, bindings);
//            } catch (Throwable ex) {
//                ex.printStackTrace();
//                throw new RuntimeException(ex);
//            }
//
//            if (result instanceof Number) {
//                return new DefaultTruth(((Number)result).floatValue(), 0.99f);
//            }
//            if (result instanceof Object[]) {
//                if (((Object[])result).length &gt; 1) {
//                    Object a = ((Object[])result)[0];
//                    Object b = ((Object[])result)[1];
//                    if ((a instanceof Number) &amp;&amp; (b instanceof Number)) {
//                        return new DefaultTruth(((Number) a).floatValue(), ((Number) b).floatValue());
//                    }
//                }
//            }
//
//            return null;
//        }
//    }


//    /** create dynamic javascript functions */
//    public class jsbelief extends NullOperator {
//
//
//        @Override
//        public List&lt;Task&gt; apply(Operation op) {
//            Term[] x = op.args();
//
//            String functionCode = Atom.unquote(x[0]);
//
//            nar.on(new JSBelievedConceptBuilder(functionCode));
//
//            op.stop();
//
//            return null;
//        }
//
//    }

//
//    @Override
//    public boolean setEnabled(NAR n, boolean enabled) {
//        //this is a plugin which attches additional plugins. kind of messy, this will change
//        boolean x = super.setEnabled(n, enabled);
//        if (enabled) {
//            n.onExec(new jsop());
//            //n.on(new jsbelief());
//        }
//        return x;
//    }


    @NotNull
    public Bindings newBindings(NAR nar, Term[] args) {

<span class="nc" id="L182">        Bindings bindings = new SimpleBindings();</span>
<span class="nc" id="L183">        bindings.put(&quot;global&quot;, global);</span>
<span class="nc" id="L184">        bindings.put(&quot;js&quot;, this);</span>
<span class="nc" id="L185">        bindings.put(&quot;arg&quot;, args);</span>
<span class="nc" id="L186">        bindings.put(&quot;memory&quot;, nar);</span>
<span class="nc" id="L187">        bindings.put(&quot;nar&quot;, nar);</span>

<span class="nc" id="L189">        return bindings;</span>
    }


    @Nullable
    @Override public Object function(@NotNull Compound o, TermBuilder i) {
<span class="nc" id="L195">        Term[] args = Operator.opArgsArray(o);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (args.length &lt; 1) {</span>
<span class="nc" id="L197">            return null;</span>
        }

        // copy over all arguments
<span class="nc" id="L201">        Term[] scriptArguments = new Term[args.length - 1];</span>
<span class="nc" id="L202">        System.arraycopy(args, 1, scriptArguments, 0, args.length-1);</span>

<span class="nc" id="L204">        Bindings bindings = newBindings(null /*TODO */, scriptArguments);</span>


        
<span class="nc" id="L208">        String input = args[0].toString();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (input.charAt(0) == '&quot;') {</span>
<span class="nc" id="L210">            input = input.substring(1, input.length() - 1);</span>
        }
        Object result;
        try {

<span class="nc" id="L215">            result = js.get().eval(input, bindings);</span>
<span class="nc" id="L216">        } catch (Throwable ex) {</span>
<span class="nc" id="L217">            throw new RuntimeException(ex);</span>
<span class="nc" id="L218">        }</span>
<span class="nc" id="L219">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>